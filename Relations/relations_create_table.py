# %%
import pandas as pd
from sqlalchemy import inspect
from Infra.database_utils import sql

#%%
class RelationsTable:
    def __init__(self, engine):
        self.engine = engine

    def create_table(self):
        """
        Cria uma tabela no banco de dados a partir das queries e mapeamento com Pandas.

        select * from Team_Attributes_Modified
        team_to_country_map = {
            'AAR': 1,
            'ABE': 1729,
            'AJA': 13274,
            'ACM': 10257,
            'ACA': 4769,
            'ALM': 15722,
            'AND': 17642,
            'ARK': 21518,
            'ARL': 19694,
            'BIE': 24558,
            'ARO': 15722,
            'ARS': 1729,
            'AVL': 1729,
            'ATA': 10257,
            'BIL': 1729,
            'AUG': 7809,
            'AUX': 4769,
            'ALK': 7809,
            'BAR': 21518,
            'BAS': 7809,
            'LEV': 7809,
            'BMU': 15722,
            'BAC': 24558,
            'B-M': 15722,
            'BEL': 1729,
            'BEN': 21518,
            'BIR': 1729,
            'BLB': 1729,
            'BLA': 1729,
            'BOA': 21518,
            'BOL': 15722,
            'BOR': 1729,
            'DOR': 7809,
            'GLA': 1729,
            'BOU': 1729,
            'BRA': 1729,
            'BRE': 21518,
            'BUR': 1729,
            'CAG': 10257,
            'CAM': 4769,
            'CAR': 1729,
            'CAP': 21518,
            'CAT': 1729,
            'CEL': 15722,
            'CES': 7809,
            'CHE': 1729,
            'CHI': 7809,
            'CLB': 1729,
            'COR': 7809,
            'CKR': 15722,
            'CRY': 1729,
            'DAR': 1729,
            'GRA': 10257,
            'DIJ': 4769,
            'DUU': 15722,
            'DUN': 19694,
            'EIB': 21518,
            'EFR': 1729,
            'ELC': 1729,
            'EMP': 10257,
            'COT': 1729,
            'ESP': 21518,
            'EUP': 1729,
            'EVE': 1729,
            'ETG': 4769,
            'EXC': 1729,
            'FAL': 21518,
            'FCK': 1729,
            'GRO': 4769,
            'POR': 21518,
            'UTR': 24558,
            'VAD': 21518,
            'ZUR': 24558,
            'FEY': 13274,
            'FIO': 10257,
            'FDU': 1729,
            'FRE': 4769,
            'FRO': 1729,
            'FUL': 1729,
            'GEN': 10257,
            'GAJ': 7809,
            'GV': 10257,
            'GAE': 21518,
            'LEC': 1729,
            'GOR': 1729,
            'GRE': 1729,
            'GRF': 21518,
            'GUI': 7809,
            'HAM': 1729,
            'HAN': 7809,
            'HER': 7809,
            'HBE': 21518,
            'HIB': 19694,
            'HOF': 7809,
            'HUL': 1729,
            'ING': 1729,
            'INT': 10257,
            'BIA': 10257,
            'JUV': 10257,
            'KAI': 7809,
            'KAR': 1729,
            'KIL': 1729,
            'KKI': 7809,
            'KOR': 7809,
            'MEC': 21518,
            'LAS': 21518,
            'LAU': 21518,
            'LAZ': 10257,
            'LEH': 15722,
            'LEM': 21518,
            'POZ': 15722,
            'LGD': 4769,
            'LEG': 4769,
            'LEI': 1729,
            'LEN': 1729,
            'LIE': 7809,
            'LIL': 4769,
            'LIV': 1729,
            'LOD': 21518,
            'LOK': 7809,
            'LOR': 21518,
            'LUZ': 21518,
            'LYO': 4769,
            'MAI': 4769,
            'MAL': 21518,
            'MUN': 7809,
            'MAR': 21518,
            'MET': 21518,
            'MID': 1729,
            'MON': 4769,
            'MOT': 15722,
            'NAC': 13274,
            'NAN': 1729,
            'NAV': 21518,
            'NEW': 1729,
            'NIC': 15722,
            'NOR': 1729,
            'NOV': 21518,
            'NUR': 1729,
            'NUM': 21518,
            'ODR': 21518,
            'OOS': 21518,
            'OSA': 21518,
            'O-H': 21518,
            'FER': 21518,
            'PAL': 10257,
            'PSG': 4769,
            'PAR': 4769,
            'ZWO': 21518,
            'PEN': 21518,
            'PIG': 21518,
            'POD': 21518,
            'POG': 21518,
            'POB': 21518,
            'PSV': 21518,
            'QPR': 1729,
            'SAN': 10257,
            'RAN': 21518,
            'REA': 1729,
            'BET': 21518,
            'SOC': 21518,
            'HUE': 21518,
            'REG': 21518,
            'REI': 21518,
            'REN': 4769,
            'RA': 21518,
            'RKC': 21518,
            'SIE': 10257,
            'ROD': 1729,
            'ROS': 21518,
            'ROM': 10257,
            'CHO': 4769,
            'ETI': 15722,
            'SAM': 10257,
            'SAS': 10257,
            'HEE': 21518,
            'S04': 7809,
            'SER': 1729,
            'SEV': 21518,
            'SLA': 21518,
            'SOU': 1729,
            'SPA': 21518,
            'SCP': 21518,
            'SPG': 21518,
            'NAP': 10257,
            'GAL': 10257,
            'MIR': 21518,
            'STP': 21518,
            'JOH': 21518,
            'STL': 21518,
            'STK': 1729,
            'SUN': 1729,
            'THU': 21518,
            'TOR': 21518,
            'TOT': 1729,
            'TOU': 4769,
            'TRO': 21518,
            'TWE': 24558,
            'UDI': 10257,
            'ULE': 21518,
            'VAL': 1729,
            'VER': 21518,
            'STU': 15722,
            'VIL': 21518,
            'VIT': 21518,
            'SET': 24558,
            'VEN': 21518,
            'WAA': 21518,
            'WAT': 1729,
            'WBR': 1729,
            'WBA': 1729,
            'WHU': 1729,
            'WES': 1729,
            'WID': 21518,
            'WIG': 1729,
            'WII': 1729,
            'WIS': 1729,
            'WOL': 10257,
            'XAM': 1729,
            'XER': 21518,
            'ZAG': 21518,
            'ZAR': 21518,
            'ZAW': 21518,
            'ZUL': 21518
        }
        
        SELECT 
            League.id, 
            League.country_id,
            League.name as league_name,
            Country.name as country_name
        FROM Country
        JOIN League ON League.country_id = Country.id;

        Args:
            nome_tabela (str): O nome da tabela a ser criada.

        Returns:
            None
        """
        assert self.engine, "A conexão com o banco de dados não foi criada corretamente."

        inspector = inspect(self.engine)

        if inspector.has_table('Relations'):
            print("A tabela 'Relations' já existe no banco de dados.")

        # Decisões tomadas com base na análise do Jupyter Notebook 'Analysis.ipynb'
        query = 'select * from Team_Attributes_Modified'
        df_player_attributes = sql(query, self.engine)
        team_to_country_map = {
            'AAR': 1,
            'ABE': 1729,
            'AJA': 13274,
            'ACM': 10257,
            'ACA': 4769,
            'ALM': 15722,
            'AND': 17642,
            'ARK': 21518,
            'ARL': 19694,
            'BIE': 24558,
            'ARO': 15722,
            'ARS': 1729,
            'AVL': 1729,
            'ATA': 10257,
            'BIL': 1729,
            'AUG': 7809,
            'AUX': 4769,
            'ALK': 7809,
            'BAR': 21518,
            'BAS': 7809,
            'LEV': 7809,
            'BMU': 15722,
            'BAC': 24558,
            'B-M': 15722,
            'BEL': 1729,
            'BEN': 21518,
            'BIR': 1729,
            'BLB': 1729,
            'BLA': 1729,
            'BOA': 21518,
            'BOL': 15722,
            'BOR': 1729,
            'DOR': 7809,
            'GLA': 1729,
            'BOU': 1729,
            'BRA': 1729,
            'BRE': 21518,
            'BUR': 1729,
            'CAG': 10257,
            'CAM': 4769,
            'CAR': 1729,
            'CAP': 21518,
            'CAT': 1729,
            'CEL': 15722,
            'CES': 7809,
            'CHE': 1729,
            'CHI': 7809,
            'CLB': 1729,
            'COR': 7809,
            'CKR': 15722,
            'CRY': 1729,
            'DAR': 1729,
            'GRA': 10257,
            'DIJ': 4769,
            'DUU': 15722,
            'DUN': 19694,
            'EIB': 21518,
            'EFR': 1729,
            'ELC': 1729,
            'EMP': 10257,
            'COT': 1729,
            'ESP': 21518,
            'EUP': 1729,
            'EVE': 1729,
            'ETG': 4769,
            'EXC': 1729,
            'FAL': 21518,
            'FCK': 1729,
            'GRO': 4769,
            'POR': 21518,
            'UTR': 24558,
            'VAD': 21518,
            'ZUR': 24558,
            'FEY': 13274,
            'FIO': 10257,
            'FDU': 1729,
            'FRE': 4769,
            'FRO': 1729,
            'FUL': 1729,
            'GEN': 10257,
            'GAJ': 7809,
            'GV': 10257,
            'GAE': 21518,
            'LEC': 1729,
            'GOR': 1729,
            'GRE': 1729,
            'GRF': 21518,
            'GUI': 7809,
            'HAM': 1729,
            'HAN': 7809,
            'HER': 7809,
            'HBE': 21518,
            'HIB': 19694,
            'HOF': 7809,
            'HUL': 1729,
            'ING': 1729,
            'INT': 10257,
            'BIA': 10257,
            'JUV': 10257,
            'KAI': 7809,
            'KAR': 1729,
            'KIL': 1729,
            'KKI': 7809,
            'KOR': 7809,
            'MEC': 21518,
            'LAS': 21518,
            'LAU': 21518,
            'LAZ': 10257,
            'LEH': 15722,
            'LEM': 21518,
            'POZ': 15722,
            'LGD': 4769,
            'LEG': 4769,
            'LEI': 1729,
            'LEN': 1729,
            'LIE': 7809,
            'LIL': 4769,
            'LIV': 1729,
            'LOD': 21518,
            'LOK': 7809,
            'LOR': 21518,
            'LUZ': 21518,
            'LYO': 4769,
            'MAI': 4769,
            'MAL': 21518,
            'MUN': 7809,
            'MAR': 21518,
            'MET': 21518,
            'MID': 1729,
            'MON': 4769,
            'MOT': 15722,
            'NAC': 13274,
            'NAN': 1729,
            'NAV': 21518,
            'NEW': 1729,
            'NIC': 15722,
            'NOR': 1729,
            'NOV': 21518,
            'NUR': 1729,
            'NUM': 21518,
            'ODR': 21518,
            'OOS': 21518,
            'OSA': 21518,
            'O-H': 21518,
            'FER': 21518,
            'PAL': 10257,
            'PSG': 4769,
            'PAR': 4769,
            'ZWO': 21518,
            'PEN': 21518,
            'PIG': 21518,
            'POD': 21518,
            'POG': 21518,
            'POB': 21518,
            'PSV': 21518,
            'QPR': 1729,
            'SAN': 10257,
            'RAN': 21518,
            'REA': 1729,
            'BET': 21518,
            'SOC': 21518,
            'HUE': 21518,
            'REG': 21518,
            'REI': 21518,
            'REN': 4769,
            'RA': 21518,
            'RKC': 21518,
            'SIE': 10257,
            'ROD': 1729,
            'ROS': 21518,
            'ROM': 10257,
            'CHO': 4769,
            'ETI': 15722,
            'SAM': 10257,
            'SAS': 10257,
            'HEE': 21518,
            'S04': 7809,
            'SER': 1729,
            'SEV': 21518,
            'SLA': 21518,
            'SOU': 1729,
            'SPA': 21518,
            'SCP': 21518,
            'SPG': 21518,
            'NAP': 10257,
            'GAL': 10257,
            'MIR': 21518,
            'STP': 21518,
            'JOH': 21518,
            'STL': 21518,
            'STK': 1729,
            'SUN': 1729,
            'THU': 21518,
            'TOR': 21518,
            'TOT': 1729,
            'TOU': 4769,
            'TRO': 21518,
            'TWE': 24558,
            'UDI': 10257,
            'ULE': 21518,
            'VAL': 1729,
            'VER': 21518,
            'STU': 15722,
            'VIL': 21518,
            'VIT': 21518,
            'SET': 24558,
            'VEN': 21518,
            'WAA': 21518,
            'WAT': 1729,
            'WBR': 1729,
            'WBA': 1729,
            'WHU': 1729,
            'WES': 1729,
            'WID': 21518,
            'WIG': 1729,
            'WII': 1729,
            'WIS': 1729,
            'WOL': 10257,
            'XAM': 1729,
            'XER': 21518,
            'ZAG': 21518,
            'ZAR': 21518,
            'ZAW': 21518,
            'ZUL': 21518
        }
        df_player_attributes["country_id"] = df_player_attributes["team_short_name"].map(team_to_country_map)# type:ignore
        query = '''
            SELECT 
                League.id, 
                League.country_id,
                League.name as league_name,
                Country.name as country_name
            FROM Country
            JOIN League ON League.country_id = Country.id;
        '''
        df_league_country = sql(query, self.engine)
        
        # Merge dos Dataframes pela coluna "country_id" mantendo apenas a coluna com o nome do país e da liga
        df_relations = pd.merge(df_player_attributes, df_league_country[['country_id', 'league_name', 'country_name']], left_on='country_id', right_on='country_id', how='inner')

        # Criar a tabela no banco de dados
        df_relations.to_sql('Relations', self.engine, index=False, if_exists='replace')
        print(f"Tabela 'Relations' criada no banco de dados. Inseridos '{len(df_relations)}' registros")

# %%